/*------------------------------------------------------------------------*/
/*  Copyright 2014 National Renewable Energy Laboratory.                  */
/*  This software is released under the license detailed                  */
/*  in the file, LICENSE, which is located in the top-level Nalu          */
/*  directory structure                                                   */
/*------------------------------------------------------------------------*/

#include "kernels/UnitTestKernelUtils.h"
#include "UnitTestUtils.h"

#include "MomentumAdvDiffElemKernel.h"

namespace {
namespace hex8_golds {
namespace advection_diffusion {
static constexpr double lhs[24][24] = {
  {
    0.05625,  0.009375,  0.009375,  -0.01875, -0.009375, -0.009375,
    -0.0125,  -0.009375, -0.003125, 0,        0.009375,  0.003125,
    0,        0.003125,  0.009375,  -0.0125,  -0.003125, -0.009375,
    -0.00625, -0.003125, -0.003125, -0.00625, 0.003125,  0.003125,
  },
  {
    0.009375,  0.05625,  0.009375,  0.009375,  0,        0.003125,
    -0.009375, -0.0125,  -0.003125, -0.009375, -0.01875, -0.009375,
    0.003125,  0,        0.009375,  0.003125,  -0.00625, 0.003125,
    -0.003125, -0.00625, -0.003125, -0.003125, -0.0125,  -0.009375,
  },
  {
    0.009375,  0.009375,  0.05625,  0.009375,  0.003125,  0,
    0.003125,  0.003125,  -0.00625, 0.003125,  0.009375,  0,
    -0.009375, -0.009375, -0.01875, -0.009375, -0.003125, -0.0125,
    -0.003125, -0.003125, -0.00625, -0.003125, -0.009375, -0.0125,
  },
  {
    -0.01875, 0.009375,  0.009375,  0.05625,  -0.009375, -0.009375,
    0,        -0.009375, -0.003125, -0.0125,  0.009375,  0.003125,
    -0.0125,  0.003125,  0.009375,  0,        -0.003125, -0.009375,
    -0.00625, -0.003125, -0.003125, -0.00625, 0.003125,  0.003125,
  },
  {
    -0.009375, 0,        0.003125,  -0.009375, 0.05625,  0.009375,
    0.009375,  -0.01875, -0.009375, 0.009375,  -0.0125,  -0.003125,
    -0.003125, -0.00625, 0.003125,  -0.003125, 0,        0.009375,
    0.003125,  -0.0125,  -0.009375, 0.003125,  -0.00625, -0.003125,
  },
  {
    -0.009375, 0.003125,  0,       -0.009375, 0.009375,  0.05625,
    -0.003125, 0.009375,  0,       -0.003125, 0.003125,  -0.00625,
    0.009375,  -0.003125, -0.0125, 0.009375,  -0.009375, -0.01875,
    0.003125,  -0.009375, -0.0125, 0.003125,  -0.003125, -0.00625,
  },
  {
    -0.0125,  -0.009375, 0.003125,  0,        0.009375,  -0.003125,
    0.05625,  0.009375,  -0.009375, -0.01875, -0.009375, 0.009375,
    -0.00625, -0.003125, 0.003125,  -0.00625, 0.003125,  -0.003125,
    0,        0.003125,  -0.009375, -0.0125,  -0.003125, 0.009375,
  },
  {
    -0.009375, -0.0125,  0.003125,  -0.009375, -0.01875, 0.009375,
    0.009375,  0.05625,  -0.009375, 0.009375,  0,        -0.003125,
    -0.003125, -0.00625, 0.003125,  -0.003125, -0.0125,  0.009375,
    0.003125,  0,        -0.009375, 0.003125,  -0.00625, -0.003125,
  },
  {
    -0.003125, -0.003125, -0.00625, -0.003125, -0.009375, 0,
    -0.009375, -0.009375, 0.05625,  -0.009375, -0.003125, 0,
    0.003125,  0.003125,  -0.00625, 0.003125,  0.009375,  -0.0125,
    0.009375,  0.009375,  -0.01875, 0.009375,  0.003125,  -0.0125,
  },
  {
    0,        -0.009375, 0.003125,  -0.0125,  0.009375,  -0.003125,
    -0.01875, 0.009375,  -0.009375, 0.05625,  -0.009375, 0.009375,
    -0.00625, -0.003125, 0.003125,  -0.00625, 0.003125,  -0.003125,
    -0.0125,  0.003125,  -0.009375, 0,        -0.003125, 0.009375,
  },
  {
    0.009375,  -0.01875, 0.009375,  0.009375,  -0.0125,  0.003125,
    -0.009375, 0,        -0.003125, -0.009375, 0.05625,  -0.009375,
    0.003125,  -0.0125,  0.009375,  0.003125,  -0.00625, 0.003125,
    -0.003125, -0.00625, -0.003125, -0.003125, 0,        -0.009375,
  },
  {
    0.003125,  -0.009375, 0,       0.003125,  -0.003125, -0.00625,
    0.009375,  -0.003125, 0,       0.009375,  -0.009375, 0.05625,
    -0.003125, 0.009375,  -0.0125, -0.003125, 0.003125,  -0.00625,
    -0.009375, 0.003125,  -0.0125, -0.009375, 0.009375,  -0.01875,
  },
  {
    0,        0.003125,  -0.009375, -0.0125,  -0.003125, 0.009375,
    -0.00625, -0.003125, 0.003125,  -0.00625, 0.003125,  -0.003125,
    0.05625,  0.009375,  -0.009375, -0.01875, -0.009375, 0.009375,
    -0.0125,  -0.009375, 0.003125,  0,        0.009375,  -0.003125,
  },
  {
    0.003125,  0,        -0.009375, 0.003125,  -0.00625, -0.003125,
    -0.003125, -0.00625, 0.003125,  -0.003125, -0.0125,  0.009375,
    0.009375,  0.05625,  -0.009375, 0.009375,  0,        -0.003125,
    -0.009375, -0.0125,  0.003125,  -0.009375, -0.01875, 0.009375,
  },
  {
    0.009375,  0.009375,  -0.01875, 0.009375,  0.003125,  -0.0125,
    0.003125,  0.003125,  -0.00625, 0.003125,  0.009375,  -0.0125,
    -0.009375, -0.009375, 0.05625,  -0.009375, -0.003125, 0,
    -0.003125, -0.003125, -0.00625, -0.003125, -0.009375, 0,
  },
  {
    -0.0125,  0.003125,  -0.009375, 0,        -0.003125, 0.009375,
    -0.00625, -0.003125, 0.003125,  -0.00625, 0.003125,  -0.003125,
    -0.01875, 0.009375,  -0.009375, 0.05625,  -0.009375, 0.009375,
    0,        -0.009375, 0.003125,  -0.0125,  0.009375,  -0.003125,
  },
  {
    -0.003125, -0.00625, -0.003125, -0.003125, 0,        -0.009375,
    0.003125,  -0.0125,  0.009375,  0.003125,  -0.00625, 0.003125,
    -0.009375, 0,        -0.003125, -0.009375, 0.05625,  -0.009375,
    0.009375,  -0.01875, 0.009375,  0.009375,  -0.0125,  0.003125,
  },
  {
    -0.009375, 0.003125,  -0.0125, -0.009375, 0.009375,  -0.01875,
    -0.003125, 0.009375,  -0.0125, -0.003125, 0.003125,  -0.00625,
    0.009375,  -0.003125, 0,       0.009375,  -0.009375, 0.05625,
    0.003125,  -0.009375, 0,       0.003125,  -0.003125, -0.00625,
  },
  {
    -0.00625, -0.003125, -0.003125, -0.00625, 0.003125,  0.003125,
    0,        0.003125,  0.009375,  -0.0125,  -0.003125, -0.009375,
    -0.0125,  -0.009375, -0.003125, 0,        0.009375,  0.003125,
    0.05625,  0.009375,  0.009375,  -0.01875, -0.009375, -0.009375,
  },
  {
    -0.003125, -0.00625, -0.003125, -0.003125, -0.0125,  -0.009375,
    0.003125,  0,        0.009375,  0.003125,  -0.00625, 0.003125,
    -0.009375, -0.0125,  -0.003125, -0.009375, -0.01875, -0.009375,
    0.009375,  0.05625,  0.009375,  0.009375,  0,        0.003125,
  },
  {
    -0.003125, -0.003125, -0.00625, -0.003125, -0.009375, -0.0125,
    -0.009375, -0.009375, -0.01875, -0.009375, -0.003125, -0.0125,
    0.003125,  0.003125,  -0.00625, 0.003125,  0.009375,  0,
    0.009375,  0.009375,  0.05625,  0.009375,  0.003125,  0,
  },
  {
    -0.00625, -0.003125, -0.003125, -0.00625, 0.003125,  0.003125,
    -0.0125,  0.003125,  0.009375,  0,        -0.003125, -0.009375,
    0,        -0.009375, -0.003125, -0.0125,  0.009375,  0.003125,
    -0.01875, 0.009375,  0.009375,  0.05625,  -0.009375, -0.009375,
  },
  {
    0.003125,  -0.0125,  -0.009375, 0.003125,  -0.00625, -0.003125,
    -0.003125, -0.00625, 0.003125,  -0.003125, 0,        0.009375,
    0.009375,  -0.01875, -0.009375, 0.009375,  -0.0125,  -0.003125,
    -0.009375, 0,        0.003125,  -0.009375, 0.05625,  0.009375,
  },
  {
    0.003125,  -0.009375, -0.0125, 0.003125,  -0.003125, -0.00625,
    0.009375,  -0.003125, -0.0125, 0.009375,  -0.009375, -0.01875,
    -0.003125, 0.009375,  0,       -0.003125, 0.003125,  -0.00625,
    -0.009375, 0.003125,  0,       -0.009375, 0.009375,  0.05625,
  },
};
} // advection_diffusion
} // hex8_golds
} // anonymous namespace

TEST_F(MomentumKernelHex8Mesh, advection_diffusion)
{
  fill_mesh_and_init_fields();

  // Setup solution options for default advection kernel
  solnOpts_.meshMotion_ = false;
  solnOpts_.meshDeformation_ = false;
  solnOpts_.externalMeshDeformation_ = false;
  solnOpts_.includeDivU_ = 0.0;

  // Initialize the kernel driver
  unit_test_kernel_utils::TestKernelDriver assembleKernels(
    bulk_, partVec_, coordinates_, spatialDim_, stk::topology::HEX_8);

  // Initialize the kernel
  std::unique_ptr<sierra::nalu::Kernel> kernel(
    new sierra::nalu::MomentumAdvDiffElemKernel<sierra::nalu::AlgTraitsHex8>(
      bulk_, solnOpts_, velocity_, viscosity_,
      assembleKernels.dataNeededByKernels_));

  // Add to kernels to be tested
  assembleKernels.activeKernels_.push_back(kernel.get());

  // Populate LHS and RHS
  assembleKernels.execute();

  EXPECT_EQ(assembleKernels.lhs_.dimension(0), 24u);
  EXPECT_EQ(assembleKernels.lhs_.dimension(1), 24u);
  EXPECT_EQ(assembleKernels.rhs_.dimension(0), 24u);

  namespace gold_values = ::hex8_golds::advection_diffusion;
  unit_test_kernel_utils::expect_all_near(assembleKernels.rhs_, 0.0);
  unit_test_kernel_utils::expect_all_near(assembleKernels.lhs_, gold_values::lhs);
}
